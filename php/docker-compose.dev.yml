services:
  devcontainer:
    container_name: ${APP_NAME}.devcontainer
    build:
      context: ./php/devcontainer
      dockerfile: Dockerfile
      # TODO this allows the SSH agent to be shared with the dockerfile
      # ssh:
      #   - default
    working_dir: '/config/www'
    environment:
      # FIXME I think this environment variable is not being read correctly
      - PHP_VERSION=8.0
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TIMEZONE:-Europe/Amsterdam}
    tty: true
    volumes:
      - '/home/${USER:-jordy}/.npmrc:/root/.npmrc'
      - '/home/${USER:-jordy}/.config/composer/auth.json:/root/.config/composer/auth.json'
      - '/home/jordy/Development/bttr/klikvrijwilligers/nuxt:/config/www'

  node:
    container_name: ${APP_NAME}.node
    image: 'node:${NODE_VERSION}'
    user: node
    working_dir: '/var/www/html'
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    ports:
      - '${FORWARD_NODE_PORT:-3000}:3000'
      - '${FORWARD_VITE_PORT:-24678}:24678'
    environment:
      - NODE_ENV=${APP_ENV:-development}
      - NUXT_HOST=node
      - NUXT_PORT=${FORWARD_NODE_PORT:-3000}
    volumes:
      - '../nuxt:/var/www/html'
    command: 'npm run dev'
    depends_on:
      - php

  php:
    container_name: ${APP_NAME}.php
    build:
      context: ./php/8.0
      dockerfile: Dockerfile
    working_dir: '/app/www'
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    ports:
      - '${FORWARD_PHP_PORT:-80}:80'
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - XDEBUG_MODE=${PHP_XDEBUG_MODE:-off}
      - XDEBUG_CONFIG=${PHP_XDEBUG_CONFIG:-client_host=host.docker.internal}
    volumes:
      - '/home/jordy/Development/bttr/klikvrijwilligers/api:/config/www'
    depends_on:
      - meilisearch
      - mysql
      - redis

    phpmyadmin:
      image: phpmyadmin:latest
      container_name: ${APP_NAME}.phpmyadmin
      environment:
        - MYSQL_ROOT_PASSWORD=${DB_PASSWORD}
        - MYSQL_USER=${DB_USERNAME}
        - MYSQL_PASSWORD=${DB_PASSWORD}
        - PMA_HOST=${APP_NAME}.mysql
        - PMA_PMADB=phpmyadmin
        - UPLOAD_LIMIT=512M
      restart: unless-stopped
      ports:
        - ${PHPMYADMIN_PORT:-8888}:80
      depends_on:
        - mysql

  mailhog:
    container_name: ${APP_NAME}.mailhog
    image: 'mailhog/mailhog:latest'
    ports:
      - '${FORWARD_MAILHOG_PORT:-1025}:1025'
      - '${FORWARD_MAILHOG_DASHBOARD_PORT:-8025}:8025'
